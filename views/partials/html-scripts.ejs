<script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
<script>
  // ************* Navbar 主題選擇器 *************
  const themeDropdown = document.querySelector("details.my-theme-selector");
  // 主題切換功能
  function changeTheme(event) {
    const theme = event.target.closest("a").getAttribute("data-theme");
    // 更改 html 元素的 data-theme 屬性
    document.documentElement.setAttribute("data-theme", theme);
    Cookies.set("preferredTheme", theme, {expires: 365}); // 儲存到 Cookies
    // 更新當前主題指示器
    updateCurrentThemeIndicator(theme);
    // 更新選單中的選中狀態
    updateActiveThemeMenuItem(theme);
    // 關閉下拉選單
    themeDropdown.removeAttribute("open");
    // 防止預設連結行為
    event.preventDefault();
  }

  function updateCurrentThemeIndicator(theme) {
    const indicator = themeDropdown.querySelector("#currentTheme");
    indicator.textContent = theme;
    indicator.className = `badge badge-sm ml-1 badge-${
      theme === "dark" ? "neutral" : "primary"
    }`;
  }

  function updateActiveThemeMenuItem(theme) {
    // 移除所有主題選單項目的選中類別
    document.querySelectorAll(".menu a[data-theme]").forEach((item) => {
      item.classList.remove("active");
    });

    // 為當前主題添加選中類別
    const activeItem = document.querySelector(`.menu a[data-theme="${theme}"]`);
    if (activeItem) {
      activeItem.classList.add("active");
    }
  }

  // 頁面載入時初始化主題
  function initializeTheme() {
    // const savedTheme = localStorage.getItem("preferredTheme") || "retro";
    const savedTheme = Cookies.get("preferredTheme") || "retro";

    // 應用主題
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateCurrentThemeIndicator(savedTheme);
    updateActiveThemeMenuItem(savedTheme);
  }

  // 點擊外部時自動收合下拉選單
  function setupDropdownAutoClose() {
    document.addEventListener("click", function (event) {
      // 尋找所有 details 元素（下拉選單）
      const allDetails = document.querySelectorAll("details[open]");

      allDetails.forEach((detail) => {
        // 檢查點擊是否在此下拉選單外部
        if (!detail.contains(event.target)) {
          detail.removeAttribute("open");
        }
      });
    });
  }

  // DOM 準備就緒時執行
  document.addEventListener("DOMContentLoaded", function () {
    initializeTheme();
    setupDropdownAutoClose();
  });
</script>
